<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSK 1 Listening Master V9.0 - XUSFUNCHINESE</title>
    <style>
        :root {
            --primary: #01579b; --gold: #fbc02d; --pinyin-red: #d63031;
            --night-sky: radial-gradient(circle at center, #001f3f 0%, #000510 100%);
            --glass: rgba(255, 255, 255, 0.15);
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Arial Black", sans-serif; overflow: hidden; background: var(--night-sky); color: white; }
        
        ruby { ruby-align: center; }
        rt { font-family: Arial, sans-serif; font-size: 0.45em; color: var(--gold); font-weight: normal; margin-bottom: 2px; }

        #cover-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--night-sky); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.8s; text-align: center; }
        .cover-title { font-size: 36px; color: var(--gold); text-shadow: 0 0 20px rgba(251,192,45,0.6); margin: 10px 0; }
        .mode-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; width: 95%; max-width: 500px; }
        .mode-btn { padding: 12px; background: transparent; border: 2px solid var(--gold); color: white; border-radius: 15px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .mode-btn b { font-size: 15px; margin-bottom: 4px; }
        .mode-btn small { font-size: 11px; opacity: 0.8; font-family: sans-serif; }
        .mode-btn:hover { background: var(--gold); color: #000; }

        #app { display: none; height: 100vh; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-icon { background: var(--glass); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 10px; cursor: pointer; }
        .progress-bar { flex-grow: 1; height: 10px; background: rgba(255,255,255,0.2); margin: 0 15px; border-radius: 5px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: var(--gold); transition: 0.3s; }
        
        .content-card { background: var(--glass); backdrop-filter: blur(15px); border-radius: 25px; flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        #audio-trigger { width: 90px; height: 90px; border-radius: 50%; background: var(--gold); border: none; font-size: 40px; cursor: pointer; margin-bottom: 15px; box-shadow: 0 0 20px rgba(251,192,45,0.4); }
        
        .option-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 700px; }
        .opt-item { background: white; color: #001f3f; padding: 12px; border-radius: 12px; text-align: center; font-size: 17px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 2px solid transparent; line-height: 1.4; }
        .opt-item:active { transform: scale(0.95); }
        .opt-img { font-size: 45px; line-height: 1.1; }

        .overlay-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #001122; z-index: 6000; display: none; padding: 20px; box-sizing: border-box; }
        .scroll-area { height: calc(100% - 120px); overflow-y: auto; margin-top: 15px; }
        .list-card { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        
        #summary-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--night-sky); z-index: 8000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .score-circle { width: 150px; height: 150px; border: 5px solid var(--gold); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 20px; }
        .footer-nav { display: flex; gap: 20px; margin-top: 15px; width: 100%; max-width: 600px; }
        .nav-arrow { flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid white; color: white; border-radius: 10px; cursor: pointer; }
        #feedback-pop { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; display: none; z-index: 9000; pointer-events: none; }
    </style>
</head>
<body>

<div id="cover-page">
    <div style="font-size: 50px;">ğŸ®</div>
    <h1 class="cover-title">HSK 1 LISTENING 100</h1>
    <div class="mode-grid">
        <button class="mode-btn" onclick="startApp(0)"><b>Part 1</b><small>Judgement Task</small></button>
        <button class="mode-btn" onclick="startApp(20)"><b>Part 2</b><small>Picture Selection</small></button>
        <button class="mode-btn" onclick="startApp(40)"><b>Part 3</b><small>Dialogue Matching</small></button>
        <button class="mode-btn" onclick="startApp(60)"><b>Part 4</b><small>Question & Answer</small></button>
        <button class="mode-btn" style="grid-column: span 2; border-color: #4cd137;" onclick="startApp(80)"><b>Part 5: Logic Reasoning</b><small>Extended Dialogues with 4 Options</small></button>
    </div>
    <button class="mode-btn" style="margin-top:15px; width: 220px; border-color: #fff;" onclick="toggleOverlay('mistake-view', true)"><b>Mistake Book</b><small>Review Errors</small></button>
</div>

<div id="summary-screen">
    <h1 id="sum-title" style="color:var(--gold)">COMPLETED!</h1>
    <div class="score-circle"><div style="font-size: 14px;">SCORE</div><div class="score-num" id="final-score" style="font-size: 50px; color: var(--gold);">0</div></div>
    <div id="praise-text" style="font-size: 18px; margin-bottom: 20px; padding: 0 20px;"></div>
    <button class="mode-btn" onclick="location.reload()" style="width: 200px;">Main Menu</button>
</div>

<div id="app">
    <div class="nav-header">
        <button class="btn-icon" onclick="exitToCover()">ğŸ  Home</button>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <button class="btn-icon" onclick="toggleOverlay('list-view', true)">ğŸ“œ List</button>
    </div>
    <div class="content-card">
        <div id="q-mode" style="background:var(--pinyin-red); color:white; padding:2px 10px; border-radius:5px; font-size:12px; margin-bottom:5px; display:none; font-weight:bold;">MISTAKE FIX</div>
        <div id="q-info" style="color: var(--gold); font-size: 14px;">PART</div>
        <div id="score-info" style="font-size: 12px; opacity: 0.7; margin-bottom: 10px;">Q 1/20</div>
        <button id="audio-trigger" onclick="playAudio()">ğŸ”Š</button>
        <div id="visual-content" style="font-size: 80px; margin-bottom: 15px; line-height: 1;"></div>
        <div class="option-container" id="options-grid"></div>
        <div class="footer-nav">
            <button class="nav-arrow" onclick="prevQuestion()">â† PREV</button>
            <button class="nav-arrow" onclick="nextQuestion()">NEXT â†’</button>
        </div>
    </div>
</div>

<div id="list-view" class="overlay-view"><h2 style="color:var(--gold)">Question List</h2><div class="scroll-area" id="list-content"></div><button class="mode-btn" style="width:100%; margin-top:10px;" onclick="toggleOverlay('list-view', false)">Back</button></div>
<div id="mistake-view" class="overlay-view"><h2 style="color:var(--pinyin-red)">Mistake Book</h2><div class="scroll-area" id="mistake-content"></div><button class="mode-btn" style="width:100%; margin-top:10px;" onclick="toggleOverlay('mistake-view', false)">Close</button></div>
<div id="feedback-pop"></div>

<script>
const pyMap = {"æˆ‘":"wÇ’","ä½ ":"nÇ","ä»–":"tÄ","å¥¹":"tÄ","ä»¬":"men","å¥½":"hÇo","æ˜¯":"shÃ¬","ä¸":"bÃ¹","æœ‰":"yÇ’u","åœ¨":"zÃ i","ä¸ª":"gÃ¨","è¿™":"zhÃ¨","é‚£":"nÃ ","å“ª":"nÇ","è°":"shÃ©i","ä»€":"shÃ©n","ä¹ˆ":"me","å‡ ":"jÇ","å²":"suÃ¬","å«":"jiÃ o","å":"mÃ­ng","å­—":"zi","å–":"hÄ“","èŒ¶":"chÃ¡","åƒ":"chÄ«","ç±³":"mÇ","é¥­":"fÃ n","æ°´":"shuÇ","æœ":"guÇ’","è‹¹":"pÃ­ng","è€":"lÇo","å¸ˆ":"shÄ«","å­¦":"xuÃ©","ç”Ÿ":"shÄ“ng","åŒ":"tÃ³ng","æ ¡":"xiÃ o","åŒ»":"yÄ«","é™¢":"yuÃ n","å•†":"shÄng","åº—":"diÃ n","é¦†":"guÇn","ç”µ":"diÃ n","è§†":"shÃ¬","å½±":"yÇng","è„‘":"nÇo","ä¹¦":"shÅ«","è¡£":"yÄ«","æœ":"fÃº","æ¯":"bÄ“i","å­":"zi","é’±":"qiÃ¡n","å—":"kuÃ i","é£":"fÄ“i","æœº":"jÄ«","å‡º":"chÅ«","ç§Ÿ":"zÅ«","è½¦":"chÄ“","å":"zuÃ²","ä¹°":"mÇi","çœ‹":"kÃ n","å¬":"tÄ«ng","è¯´":"shuÅ","è¯»":"dÃº","å†™":"xiÄ›","å¼€":"kÄi","å›":"huÃ­","æ¥":"lÃ¡i","å»":"qÃ¹","æƒ³":"xiÇng","èƒ½":"nÃ©ng","ä¼š":"huÃ¬","è¯·":"qÇng","è°¢":"xiÃ¨","å®¢":"kÃ¨","æ°”":"qi","å¯¹":"duÃ¬","èµ·":"qÇ","æ²¡":"mÃ©i","å…³":"guÄn","ç³»":"xi","å†":"zÃ i","è§":"jiÃ n","å¾ˆ":"hÄ›n","å¤ª":"tÃ i","å¤š":"duÅ","å°‘":"shÇo","å¤§":"dÃ ","å°":"xiÇo","å†·":"lÄ›ng","çƒ­":"rÃ¨","æ˜¨":"zuÃ³","å¤©":"tiÄn","ä»Š":"jÄ«n","æ˜":"mÃ­ng","å¹´":"niÃ¡n","æœˆ":"yuÃ¨","æ—¥":"rÃ¬","å·":"hÃ o","æ˜Ÿ":"xÄ«ng","æœŸ":"qÄ«","ç‚¹":"diÇn","åˆ†":"fÄ“n","é’Ÿ":"zhÅng","ç°":"xiÃ n","é‡Œ":"lÇ","ä¸Š":"shÃ ng","ä¸‹":"xiÃ ","å‰":"qiÃ¡n","å":"hÃ²u","ä¸­":"zhÅng","å›½":"guÃ³","åŒ—":"bÄ›i","äº¬":"jÄ«ng","é›¨":"yÇ”","å’Œ":"hÃ©","å‘¢":"ne","å—":"ma","å§":"ba","è¯†":"shÃ­","è®¤":"rÃ¨n","åš":"zuÃ²","çŒ«":"mÄo","ç‹—":"gÇ’u","æ¼‚äº®":"piÃ o liang","æ±‰è¯­":"hÃ n yÇ”","å–œæ¬¢":"xÇ huan","è°¢è°¢":"xiÃ¨ xie","è®¤è¯†":"rÃ¨n shi","åŒ»ç”Ÿ":"yÄ« shÄ“ng","è€å¸ˆ":"lÇo shÄ«","åŒå­¦":"tÃ³ng xuÃ©","å­¦ç”Ÿ":"xuÃ© sheng","åŒ—äº¬":"bÄ›i jÄ«ng","è‹¹æœ":"pÃ­ng guÇ’","å–èŒ¶":"hÄ“ chÃ¡","å›å®¶":"huÃ­ jiÄ","çœ‹ä¹¦":"kÃ n shÅ«","è¯´è¯":"shuÅ huÃ ","å†™å­—":"xiÄ› zÃ¬","å¤©æ°”":"tiÄn qÃ¬","ç°åœ¨":"xiÃ n zÃ i","å¤šå°‘":"duÅ shao","å†è§":"zÃ i jiÃ n","å¯¹ä¸èµ·":"duÃ¬ bu qÇ","æ²¡å…³ç³»":"mÃ©i guÄn xi","ä¸å®¢æ°”":"bÃ¹ kÃ¨ qi","æ¤…å­":"yÇ zi","æ¡Œå­":"zhuÅ zi","ç”µè§†":"diÃ n shÃ¬","ç”µè„‘":"diÃ n nÇo","ç”µå½±":"diÃ n yÇng","å¥³å„¿":"nÇš Ã©r","æœ‹å‹":"pÃ©ng you","é«˜å…´":"gÄo xÃ¬ng","è¥¿ç“œ":"xÄ« guÄ","å·¥ä½œ":"gÅng zuÃ²","èº«ä½“":"shÄ“n tÇ","æ²¡å»":"mÃ©i qÃ¹","æ˜å¤©":"mÃ­ng tiÄn","ç¾å›½":"mÄ›i guÃ³","æ¯å¤©":"mÄ›i tiÄn","å¥½çœ‹":"hÇo kÃ n","ç¬¬äºŒä¸ªäºº":"dÃ¬ Ã¨r gÃ¨ rÃ©n"};

function toRuby(str) {
    if(!str) return "";
    let res = ""; let i = 0;
    while(i < str.length) {
        let match = false;
        for(let l=4; l>=2; l--) {
            let sub = str.substr(i, l);
            if(pyMap[sub]) {
                let pys = pyMap[sub].split(' ');
                for(let j=0; j<sub.length; j++) res += `<ruby>${sub[j]}<rt>${pys[j]||''}</rt></ruby>`;
                i += l; match = true; break;
            }
        }
        if(!match) {
            let char = str[i];
            res += pyMap[char] ? `<ruby>${char}<rt>${pyMap[char]}</rt></ruby>` : char;
            i++;
        }
    }
    return res;
}

const words = [
    {c:"åŒ»ç”Ÿ", e:"ğŸ‘¨â€âš•ï¸"}, {c:"è‹¹æœ", e:"ğŸ"}, {c:"å–èŒ¶", e:"â˜•"}, {c:"çœ‹ä¹¦", e:"ğŸ“–"}, {c:"å°çŒ«", e:"ğŸ±"}, 
    {c:"ç”µè„‘", e:"ğŸ’»"}, {c:"åé£æœº", e:"âœˆï¸"}, {c:"å‡ºç§Ÿè½¦", e:"ğŸš•"}, {c:"è¡£æœ", e:"ğŸ‘•"}, {c:"åŒ—äº¬", e:"ğŸ™ï¸"}, 
    {c:"ä¸‹é›¨", e:"ğŸŒ§ï¸"}, {c:"å–æ°´", e:"ğŸ¥¤"}, {c:"çœ‹ç”µå½±", e:"ğŸ¬"}, {c:"è€å¸ˆ", e:"ğŸ‘©â€ğŸ«"}, {c:"å­¦ç”Ÿ", e:"ğŸ§’"},
    {c:"æ¡Œå­", e:"ğŸª‘"}, {c:"åƒæ°´æœ", e:"ğŸ‡"}, {c:"æ¤…å­", e:"ğŸ’º"}, {c:"å•†åº—", e:"ğŸª"}, {c:"é¥­åº—", e:"ğŸ±"}
];

const questions = [];
let currentIdx = 0, partScores = [0,0,0,0,0];
let mistakes = JSON.parse(localStorage.getItem('hsk1_list_v9_err') || '[]');
let isMistakeMode = false;

function buildData() {
    for(let i=0; i<20; i++) {
        let it = words[i]; let isT = Math.random()>0.5;
        questions.push({id:i, type:1, audio:it.c, visual:isT?it.e:words[(i+3)%20].e, answer:isT, text:it.c});
    }
    for(let i=0; i<20; i++) {
        let it = words[i]; let s = `å¥¹åœ¨${it.c}ã€‚`;
        let opts = [it.e, words[(i+1)%20].e, words[(i+2)%20].e, "ğŸ "].sort(()=>Math.random()-0.5);
        questions.push({id:i+20, type:2, audio:s, options:opts, answer:opts.indexOf(it.e), text:s});
    }
    const dls = [
        {q:"è°¢è°¢ä½ ã€‚", a:"ä¸å®¢æ°”ã€‚", e:"ğŸ™"}, {q:"å†è§ã€‚", a:"æ˜å¤©è§ã€‚", e:"ğŸ‘‹"}, {q:"ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ", a:"æˆ‘å«ææœˆã€‚", e:"ğŸ†”"},
        {q:"è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ", a:"å…«å—é’±ã€‚", e:"ğŸ’°"}, {q:"è°åœ¨æˆ¿é—´é‡Œï¼Ÿ", a:"æˆ‘çš„åŒå­¦ã€‚", e:"ğŸ§’"}, {q:"å‡ ç‚¹äº†ï¼Ÿ", a:"ç°åœ¨äº”ç‚¹ã€‚", e:"ğŸ•”"},
        {q:"ä½ ä¼šå†™æ±‰å­—å—ï¼Ÿ", a:"æˆ‘ä¼šå†™ä¸€ç‚¹å„¿ã€‚", e:"âœï¸"}, {q:"ä½ æƒ³å–ä»€ä¹ˆï¼Ÿ", a:"æˆ‘æƒ³å–çƒ­èŒ¶ã€‚", e:"â˜•"}, {q:"ä»–åœ¨åšä»€ä¹ˆï¼Ÿ", a:"ä»–åœ¨çœ‹ä¹¦ã€‚", e:"ğŸ“–"},
        {q:"ä½ å»å“ªå„¿ï¼Ÿ", a:"æˆ‘å»å•†åº—ã€‚", e:"ğŸª"}, {q:"å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ", a:"å¤ªçƒ­äº†ã€‚", e:"â˜€ï¸"}, {q:"è®¤è¯†ä»–å—ï¼Ÿ", a:"ä»–ä¸è®¤è¯†æˆ‘ã€‚", e:"ğŸ™…â€â™‚ï¸"},
        {q:"ä½ åœ¨å“ªå„¿åƒé¥­ï¼Ÿ", a:"åœ¨é¥­åº—åƒé¥­ã€‚", e:"ğŸ±"}, {q:"åé£æœºå»å—ï¼Ÿ", a:"åå‡ºç§Ÿè½¦å»ã€‚", e:"ğŸš•"}, {q:"è‹¹æœåœ¨å“ªå„¿ï¼Ÿ", a:"åœ¨æ¡Œå­ä¸Šã€‚", e:"ğŸ"},
        {q:"ä½ æ˜¯å“ªå›½äººï¼Ÿ", a:"æˆ‘æ˜¯ä¸­å›½äººã€‚", e:"ğŸ‡¨ğŸ‡³"}, {q:"ä½ å¤šå¤§äº†ï¼Ÿ", a:"æˆ‘äºŒåå²äº†ã€‚", e:"ğŸ‚"}, {q:"ä¼šæœ‰é›¨å—ï¼Ÿ", a:"æ²¡ä¸‹é›¨ã€‚", e:"ğŸŒ¤ï¸"},
        {q:"ç”µè„‘å¤šå°‘é’±ï¼Ÿ", a:"ä¸‰åƒå—ã€‚", e:"ğŸ’»"}, {q:"ååœ¨è¿™å„¿å—ï¼Ÿ", a:"è¯·ååœ¨æ¤…å­ä¸Šã€‚", e:"ğŸ’º"}
    ];
    dls.forEach((d,i)=>{
        let opts = [d.e, "ğŸ‘Ÿ", "ğŸ±", "ğŸ¢"].sort(()=>Math.random()-0.5);
        questions.push({id:i+40, type:3, audio:d.q+" "+d.a, options:opts, answer:opts.indexOf(d.e), text:d.q});
    });
    const p4 = [
        {q:"ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ", o:["æ˜ŸæœŸäº”", "äº”ç‚¹", "äº”å·", "äº”å—"], a:0},
        {q:"ä½ æƒ³åƒç‚¹å„¿ä»€ä¹ˆï¼Ÿ", o:["æƒ³åƒç±³é¥­", "ä¸è®¤è¯†", "å»å­¦æ ¡", "æ²¡å…³ç³»"], a:0},
        {q:"ä½ ä¼šè¯´æ±‰è¯­å—ï¼Ÿ", o:["æˆ‘ä¼šè¯´ä¸€ç‚¹å„¿", "æˆ‘å«å¤§å«", "å¾ˆå¥½çœ‹", "è°¢è°¢"], a:0},
        {q:"ç‹è€å¸ˆåœ¨å“ªå„¿ï¼Ÿ", o:["åœ¨åŒ»é™¢", "ä¸‰åå²", "åŒ—äº¬äºº", "æ²¡å»"], a:0},
        {q:"è¿™ä¸ªå­—æ€ä¹ˆè¯»ï¼Ÿ", o:["å¯¹ä¸èµ·æˆ‘ä¸ä¼š", "ä»–æ˜¯æˆ‘åŒå­¦", "ä¸‰å—é’±", "å¾ˆæ¼‚äº®"], a:0}
    ]; // ç®€åŒ–ç¤ºæ„ï¼Œå®é™…å¾ªç¯ç”Ÿæˆ
    for(let i=0; i<20; i++) questions.push({id:i+60, type:4, audio:p4[i%5].q, options:p4[i%5].o, answer:p4[i%5].a, text:p4[i%5].q});

    // Part 5: Extended + 4 Options
    const p5 = [
        {c:"ç”·ï¼šç‹å°å§ï¼Œä½ ç°åœ¨åœ¨å“ªå„¿ï¼Ÿæ˜¯åœ¨å®¶çœ‹ä¹¦å—ï¼Ÿ å¥³ï¼šæˆ‘æ²¡åœ¨å®¶ï¼Œæˆ‘å›å­¦æ ¡å»è§æˆ‘çš„æ±‰è¯­è€å¸ˆäº†ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººç°åœ¨åœ¨å“ªå„¿ï¼Ÿ", o:["å®¶", "å­¦æ ¡", "å•†åº—", "åŒ»é™¢"], a:1},
        {c:"å¥³ï¼šå¤§å«ï¼Œä½ æƒ³å–èŒ¶è¿˜æ˜¯å–å’–å•¡ï¼Ÿ ç”·ï¼šæˆ‘ç°åœ¨ä¸æ¸´ï¼Œæˆ‘æƒ³åƒä¸ªå¤§è¥¿ç“œã€‚ é—®ï¼šç¬¬äºŒä¸ªäººæƒ³åƒä»€ä¹ˆï¼Ÿ", o:["èŒ¶", "å’–å•¡", "è¥¿ç“œ", "è‹¹æœ"], a:2},
        {c:"ç”·ï¼šä½ çœ‹ï¼Œæˆ‘çš„å°çŒ«åœ¨é‚£å„¿ç¡è§‰å‘¢ã€‚ å¥³ï¼šå®ƒå«ä»€ä¹ˆåå­—ï¼ŸçœŸæ¼‚äº®ã€‚ç”·ï¼šå®ƒå«å°èŠ±ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè§‰å¾—å°çŒ«æ€ä¹ˆæ ·ï¼Ÿ", o:["å¾ˆå°", "å¾ˆæ¼‚äº®", "ä¸å¯çˆ±", "æƒ³ä¹°å®ƒ"], a:1},
        {c:"å¥³ï¼šä»Šå¤©å¤©æ°”å¤ªçƒ­äº†ï¼Œæˆ‘ä¸æƒ³å»å•†åº—ä¹°è¡£æœäº†ã€‚ ç”·ï¼šæ²¡å…³ç³»ï¼Œä¸‹åˆå¯èƒ½ä¼šä¸‹é›¨ï¼Œä¸‹é›¨å°±ä¸çƒ­äº†ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè§‰å¾—ä¸‹åˆå¤©æ°”ä¼šæ€ä¹ˆæ ·ï¼Ÿ", o:["å¾ˆçƒ­", "ä¸‹é›¨", "åˆ®é£", "ä¸‹é›ª"], a:1},
        {c:"ç”·ï¼šè¯·é—®ï¼Œç‹è€å¸ˆä»Šå¹´å¤šå¤§äº†ï¼Ÿ å¥³ï¼šå¥¹å‡ºç”Ÿåœ¨åŒ—äº¬ï¼Œä»Šå¹´å·²ç»ä¸‰åå²äº†ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè¯´ç‹è€å¸ˆå‡ å²äº†ï¼Ÿ", o:["äºŒåå²", "ä¸‰åå²", "å››åå²", "äº”åå²"], a:1},
        {c:"å¥³ï¼šä½ ä¼šå†™è¿™ä¸ªæ±‰å­—å—ï¼Ÿæˆ‘è§‰å¾—å¾ˆéš¾ã€‚ ç”·ï¼šå¯¹ä¸èµ·ï¼Œæˆ‘è®¤è¯†è¿™ä¸ªå­—ï¼Œä½†æ˜¯æˆ‘ä¸ä¼šå†™ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººæ€ä¹ˆäº†ï¼Ÿ", o:["ä¸è®¤è¯†å­—", "ä¸ä¼šå†™å­—", "æ²¡å¸¦ç¬”", "ä¸å–œæ¬¢å­—"], a:1},
        {c:"ç”·ï¼šä½ æƒ³å»å“ªå„¿ä¹°ä¸œè¥¿ï¼Ÿå»é‚£ä¸ªå¤§å•†åº—å—ï¼Ÿ å¥³ï¼šé‚£ä¸ªå•†åº—çš„ä¸œè¥¿å¤ªè´µäº†ï¼Œæˆ‘ä»¬å»å­¦æ ¡å‰é¢çš„å°å•†åº—å§ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººæƒ³å»å“ªå„¿ï¼Ÿ", o:["å¤§å•†åº—", "å°å•†åº—", "å­¦æ ¡å†…", "é¥­åº—"], a:1},
        {c:"å¥³ï¼šå¤§å«ï¼Œæ˜å¤©æ˜¯æ˜ŸæœŸå…­ï¼Œæˆ‘ä»¬è¦å»åŒ—äº¬æ—…æ¸¸å—ï¼Ÿ ç”·ï¼šæ˜å¤©ä¸è¡Œï¼Œæˆ‘æœ‰å¾ˆå¤šå·¥ä½œï¼Œä¸‹ä¸ªæ˜ŸæœŸæ—¥å»å§ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººæ˜å¤©è¦åšä»€ä¹ˆï¼Ÿ", o:["å»æ—…æ¸¸", "å·¥ä½œ", "å»åŒ—äº¬", "ç¡è§‰"], a:1},
        {c:"ç”·ï¼šä½ çœ‹è§æˆ‘çš„æ¯å­äº†å—ï¼Ÿæˆ‘è®°å¾—åœ¨ç”µè„‘åé¢ã€‚ å¥³ï¼šæ²¡åœ¨ç”µè„‘é‚£å„¿ï¼Œåœ¨æ¡Œå­ä¸Šå‘¢ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººåœ¨å“ªé‡Œçœ‹åˆ°äº†æ¯å­ï¼Ÿ", o:["æ¤…å­ä¸Š", "æ¡Œå­ä¸Š", "ç”µè„‘å", "ä¹¦åŒ…é‡Œ"], a:1},
        {c:"å¥³ï¼šå–‚ï¼Œè°åœ¨è¯´è¯ï¼Ÿæ˜¯æè€å¸ˆå—ï¼Ÿ ç”·ï¼šä¸æ˜¯ï¼Œæè€å¸ˆåœ¨å¼€ä¼šï¼Œæˆ‘æ˜¯å¥¹çš„å­¦ç”Ÿã€‚ é—®ï¼šç¬¬äºŒä¸ªäººæ˜¯è°ï¼Ÿ", o:["æè€å¸ˆ", "æè€å¸ˆçš„å­¦ç”Ÿ", "è€å¸ˆçš„å¥³å„¿", "æ ¡åŒ»"], a:1},
        {c:"ç”·ï¼šä½ ä»€ä¹ˆæ—¶å€™å»åŒ—äº¬ï¼Ÿæ˜¯æ˜å¤©ä¸‹åˆå—ï¼Ÿ å¥³ï¼šæˆ‘æ²¡ä¹°åˆ°æ˜å¤©çš„é£æœºç¥¨ï¼Œæˆ‘åå¤©åå‡ºç§Ÿè½¦å»ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººæ€ä¹ˆå»åŒ—äº¬ï¼Ÿ", o:["åç«è½¦", "åé£æœº", "åå‡ºç§Ÿè½¦", "å¼€è½¦"], a:2},
        {c:"å¥³ï¼šè¿™ä¸ªçº¢è‹¹æœå¤šå°‘é’±ï¼Ÿ ç”·ï¼šä¸‰å—é’±ä¸€ä¸ªï¼Œä¹°äº”ä¸ªåªè¦åå—é’±ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè¯´ä¹°äº”ä¸ªå¤šå°‘é’±ï¼Ÿ", o:["ä¸‰å—", "åå—", "åäº”å—", "äºŒåå—"], a:1},
        {c:"ç”·ï¼šä½ ä¼šåšä¸­å›½èœå—ï¼Ÿæˆ‘æƒ³åƒç±³é¥­ã€‚ å¥³ï¼šæˆ‘ä¸ä¼šåšèœï¼Œä½†æ˜¯æˆ‘çŸ¥é“ä¸€ä¸ªå¾ˆå¥½çš„é¥­åº—ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººå»ºè®®åšä»€ä¹ˆï¼Ÿ", o:["è‡ªå·±åšèœ", "åƒç±³é¥­", "å»é¥­åº—", "å»å­¦æ ¡"], a:2},
        {c:"å¥³ï¼šä½ åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿåœ¨å¬æ±‰è¯­è€å¸ˆè¯´è¯å—ï¼Ÿ ç”·ï¼šæ²¡å¬è¯´è¯ï¼Œæˆ‘åœ¨çœ‹ä¸€ä¸ªå¾ˆæœ‰åçš„ç”µå½±ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººåœ¨åšä»€ä¹ˆï¼Ÿ", o:["çœ‹ç”µå½±", "å¬è¯´è¯", "è¯»ä¹¦", "å†™æ±‰å­—"], a:0},
        {c:"ç”·ï¼šæå°å§ï¼Œä½ åœ¨å“ªå„¿å·¥ä½œï¼Ÿåœ¨åŒ»é™¢å½“åŒ»ç”Ÿå—ï¼Ÿ å¥³ï¼šæˆ‘ä¸æ˜¯åŒ»ç”Ÿï¼Œæˆ‘åœ¨é‚£å„¿çš„å•†åº—ä¹°ä¸œè¥¿ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººåœ¨å“ªå„¿ï¼Ÿ", o:["åŒ»é™¢", "å­¦æ ¡", "å•†åº—", "å®¶é‡Œ"], a:2},
        {c:"å¥³ï¼šå¤–é¢çš„å¤©æ°”å†·å—ï¼Ÿæˆ‘è¦å¤šç©¿ä¸€ä»¶è¡£æœå—ï¼Ÿ ç”·ï¼šå¤–é¢ä¸€ç‚¹å„¿ä¹Ÿä¸å†·ï¼Œéå¸¸çƒ­ï¼Œä½ åˆ«å»å¤–é¢äº†ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè§‰å¾—å¤–é¢æ€ä¹ˆæ ·ï¼Ÿ", o:["å¾ˆå†·", "å¾ˆçƒ­", "æœ‰é›ª", "æœ‰é›¨"], a:1},
        {c:"ç”·ï¼šä½ è®¤è¯†é‚£ä¸ªååœ¨æ¤…å­ä¸Šçš„ç”·äººå—ï¼Ÿ å¥³ï¼šè®¤è¯†ï¼Œä»–æ˜¯æˆ‘çš„å¤§å­¦åŒå­¦ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè®¤è¯†é‚£ä¸ªç”·äººå—ï¼Ÿ", o:["è®¤è¯†", "ä¸è®¤è¯†", "æƒ³è®¤è¯†", "ä¸çŸ¥é“"], a:0},
        {c:"å¥³ï¼šä½ å–œæ¬¢æˆ‘ä¹°çš„è¿™ä»¶çº¢è¡£æœå—ï¼Ÿ ç”·ï¼šå¾ˆæ¼‚äº®ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ä½ ç©¿ç™½è‰²çš„æ›´å¥½çœ‹ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè§‰å¾—ä»€ä¹ˆé¢œè‰²å¥½çœ‹ï¼Ÿ", o:["çº¢è‰²", "ç™½è‰²", "é»‘è‰²", "è“è‰²"], a:1},
        {c:"ç”·ï¼šè¯·é—®ï¼Œç°åœ¨ä¹ç‚¹äº†å—ï¼Ÿæˆ‘çš„æ‰‹è¡¨åäº†ã€‚ å¥³ï¼šè¿˜æ²¡åˆ°ä¹ç‚¹ï¼Œç°åœ¨æ˜¯å…«ç‚¹äº”ååˆ†ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººè¯´ç°åœ¨å‡ ç‚¹ï¼Ÿ", o:["å…«ç‚¹", "å…«ç‚¹äº”å", "ä¹ç‚¹", "ä¹ç‚¹äº”å"], a:1},
        {c:"å¥³ï¼šä½ æ€ä¹ˆæ²¡å»å­¦æ ¡ï¼Ÿç”Ÿç—…äº†å—ï¼Ÿ ç”·ï¼šæˆ‘èº«ä½“å¾ˆå¥½ï¼Œä½†æ˜¯ä»Šå¤©æ˜ŸæœŸæ—¥ï¼Œå­¦æ ¡æ²¡è¯¾ã€‚ é—®ï¼šç¬¬äºŒä¸ªäººä¸ºä»€ä¹ˆæ²¡å»å­¦æ ¡ï¼Ÿ", o:["ç”Ÿç—…äº†", "æ˜ŸæœŸæ—¥æ²¡è¯¾", "å»å•†åº—äº†", "åœ¨çœ‹ä¹¦"], a:1}
    ];
    p5.forEach((qa,i)=>questions.push({id:i+80, type:5, audio:qa.c, options:qa.o, answer:qa.a, text:qa.c.slice(0,10)}));
}

function startApp(idx) { 
    currentIdx=idx; isMistakeMode=false;
    document.getElementById('cover-page').style.transform='translateY(-100%)';
    document.getElementById('app').style.display='flex'; renderQuestion(); 
}

function playAudio(t=null) {
    window.speechSynthesis.cancel();
    const q = isMistakeMode?mistakes[currentIdx]:questions[currentIdx];
    const msg = new SpeechSynthesisUtterance(t||q.audio);
    msg.lang='zh-CN'; msg.rate=0.8; window.speechSynthesis.speak(msg);
}

function renderQuestion() {
    const q = isMistakeMode?mistakes[currentIdx]:questions[currentIdx];
    document.getElementById('q-info').innerText = isMistakeMode?`MISTAKE ${currentIdx+1}`:`PART ${Math.floor(q.id/20)+1}`;
    document.getElementById('score-info').innerText = `Question ${(currentIdx%20)+1}/20`;
    document.getElementById('progress-fill').style.width = `${((currentIdx%20)+1)/20*100}%`;
    const grid = document.getElementById('options-grid'); const visual = document.getElementById('visual-content');
    grid.innerHTML=''; visual.style.display=(q.type===1)?'block':'none';
    if(q.type===1) {
        visual.innerText = q.visual;
        grid.innerHTML=`<div class="opt-item" onclick="handleAns(true)">${toRuby('å¯¹')} True</div><div class="opt-item" onclick="handleAns(false)">${toRuby('é”™')} False</div>`;
    } else {
        q.options.forEach((o,i)=>grid.innerHTML+=`<div class="opt-item ${q.type<4?'opt-img':''}" onclick="handleAns(${i})"><b>${String.fromCharCode(65+i)}.</b> ${toRuby(o)}</div>`);
    }
    setTimeout(()=>playAudio(), 500);
}

function handleAns(c) {
    const q = isMistakeMode?mistakes[currentIdx]:questions[currentIdx]; const isR = c===q.answer;
    const fb = document.getElementById('feedback-pop'); fb.innerText=isR?"âœ”ï¸":"âŒ"; fb.style.color=isR?"#4cd137":"#ff4757"; fb.style.display='block';
    if(isR) { if(isMistakeMode) mistakes.splice(currentIdx,1); else partScores[Math.floor(q.id/20)]++; }
    else if(!isMistakeMode && !mistakes.some(m=>m.id===q.id)) mistakes.push(q);
    localStorage.setItem('hsk1_list_v9_err', JSON.stringify(mistakes));
    setTimeout(()=>{ fb.style.display='none'; if(isMistakeMode){ if(!mistakes.length) showSum(true); else {if(currentIdx>=mistakes.length)currentIdx=0; renderQuestion();} } else { if((currentIdx+1)%20===0) showSum(false); else {currentIdx++; renderQuestion();} } }, 800);
}

function showSum(m) {
    document.getElementById('summary-screen').style.display='flex';
    document.getElementById('final-score').innerText = m?100:partScores[Math.floor(currentIdx/20)]*5;
    document.getElementById('praise-text').innerText = "Keep improving your Chinese listening!";
}

function toggleOverlay(id, s) { document.getElementById(id).style.display=s?'block':'none'; if(s&&id==='list-view') renderList(); if(s&&id==='mistake-view') renderMistakeList(); }
function renderList() { document.getElementById('list-content').innerHTML = questions.map((q,i)=>`<div class="list-card" onclick="jumpTo(${i},false)"><span><b>${i+1}.</b> ${toRuby(q.text.slice(0,12))}...</span><span style="color:var(--gold)">GO</span></div>`).join(''); }
function renderMistakeList() { document.getElementById('mistake-content').innerHTML = mistakes.length?mistakes.map((q,i)=>`<div class="list-card" onclick="jumpTo(${i},true)"><span>${toRuby(q.text.slice(0,12))}</span><span style="color:var(--pinyin-red)">FIX</span></div>`).join(''):"No mistakes!"; }
function jumpTo(i,m) { currentIdx=i; isMistakeMode=m; toggleOverlay(m?'mistake-view':'list-view',false); document.getElementById('q-mode').style.display=m?'inline-block':'none'; document.getElementById('cover-page').style.transform='translateY(-100%)'; document.getElementById('app').style.display='flex'; renderQuestion(); }
function exitToCover() { document.getElementById('cover-page').style.transform='translateY(0)'; }
function prevQuestion() { if(currentIdx%20>0){currentIdx--; renderQuestion();} }
function nextQuestion() { if(currentIdx%20<19){currentIdx++; renderQuestion();} }
window.onload = buildData;
</script>
</body>
</html>